---
title: "Vaccine_ML"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:




```{r data_load}
source("sprklyRSpark.R")
source("opt_addressability.R")
sc <- sparkInit()
load_spark_parquet("../../GWCM_Extracts/FY13_17_complete.prq/")
```

```{r training_data_prep}
##subset to HHS psc 6505 
hhs_6505 <- raw_df %>% filter(product_or_service_code == "6505") %>% 
  filter(funding_department_name == "HEALTH AND HUMAN SERVICES, DEPARTMENT OF") %>%
  collect()
##add the vaccine indicator
labeled_hhs_6505 <- hhs_6505 %>% 
  mutate(vaccine = ifelse(grepl("VACCINE", description_of_requirement)==TRUE, 1, 0 ) )
##select reasonable set of evaluation variables and drop incomplete cases
selected_labeled_hhs_6505 <- labeled_hhs_6505 %>% select(date_signed, vendor_name, funding_agency_name, contracting_agency_name, product_or_service_description, naics_description, vaccine ) %>% na.omit()
##convert desired columns to factors
selected_labeled_hhs_6505 <- selected_labeled_hhs_6505 %>% mutate(vendor_name = as.factor(vendor_name))
selected_labeled_hhs_6505 <- selected_labeled_hhs_6505 %>% mutate(funding_agency_name = as.factor(funding_agency_name))
selected_labeled_hhs_6505 <- selected_labeled_hhs_6505 %>% mutate(contracting_agency_name = as.factor(contracting_agency_name))
selected_labeled_hhs_6505 <- selected_labeled_hhs_6505 %>% mutate(product_or_service_description = as.factor(product_or_service_description))
selected_labeled_hhs_6505 <- selected_labeled_hhs_6505 %>% mutate(naics_description = as.factor(naics_description))
selected_labeled_hhs_6505 <- selected_labeled_hhs_6505 %>% mutate(vaccine = as.factor(vaccine))
```



```{r test_data_prep}
fy13Test <- selected_labeled_hhs_6505 %>% filter(as.Date(date_signed) >= as.Date("2012-10-01") & as.Date(date_signed) <= as.Date("2013-09-30"))
fy14Test <- selected_labeled_hhs_6505 %>% filter(as.Date(date_signed) >= as.Date("2013-10-01") & as.Date(date_signed) <= as.Date("2014-09-30"))
fy15Test <- selected_labeled_hhs_6505 %>% filter(as.Date(date_signed) >= as.Date("2014-10-01") & as.Date(date_signed) <= as.Date("2015-09-30"))
fy16Test <- selected_labeled_hhs_6505 %>% filter(as.Date(date_signed) >= as.Date("2015-10-01") & as.Date(date_signed) <= as.Date("2016-09-30"))
fy17Test <- selected_labeled_hhs_6505 %>% filter(as.Date(date_signed) >= as.Date("2016-10-01") & as.Date(date_signed) <= as.Date("2017-09-30"))
```


```{r verify_features}
library(Boruta)
boruta.train <- Boruta(vaccine ~ vendor_name + funding_agency_name + contracting_agency_name + product_or_service_description + naics_description, data = selected_labeled_hhs_6505, doTrace = 2)
plot(boruta.train, xlab = "", xaxt = "n")
 lz<-lapply(1:ncol(boruta.train$ImpHistory),function(i)
boruta.train$ImpHistory[is.finite(boruta.train$ImpHistory[,i]),i])
 names(lz) <- colnames(boruta.train$ImpHistory)
Labels <- sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),
at = 1:ncol(boruta.train$ImpHistory), cex.axis = 0.7)
```


```{r svm_model_predict}
library(e1071)
model <- svm(vaccine ~ vendor_name + funding_agency_name + contracting_agency_name + naics_description, data = selected_labeled_hhs_6505)
pred <- predict(model, data = selected_labeled_hhs_6505)
```
